resources:
  - name: govwifi-admin
    type: git
    source:
      uri: "https://github.com/alphagov/govwifi-admin.git"
      branch: "concourse"

  - name: ecr
    # This needs to be docker-image, until registry-image supports ECR
    type: docker-image
    source:
      repository: "((ecs-registry))/govwifi/admin"
      tag: concourse-latest
      aws_access_key_id: ((ecr-access-key-id))
      aws_secret_access_key: ((ecr-secret-access-key))

  - name: mysql-image
    type: registry-image
    source:
      repository: mysql
      tag: 5.7

  - name: ruby-image
    type: registry-image
    source:
      repository: ruby
      tag: 2.6.2-alpine3.9

  - name: nginx-image
    type: registry-image
    source:
      repository: nginx
      tag: alpine

jobs:
  - name: lint & test
    plan:
      - aggregate:
        - get: govwifi-admin
          trigger: true
        - get: mysql-image
          params: {format: oci}
        - get: ruby-image
          params: {format: oci}
        - get: nginx-image
          params: {format: oci}
      - task: pre-build
        privileged: true
        file: govwifi-admin/ci/tasks/pre-build.yml
      - aggregate:
        - task: lint
          privileged: true
          file: govwifi-admin/ci/tasks/lint.yml
        - task: test
          privileged: true
          file: govwifi-admin/ci/tasks/test.yml
  - name: Push Image
    plan:
      - get: govwifi-admin
        trigger: true
        passed: ['lint & test']
      - put: ecr
        params:
          build: govwifi-admin
          build_args:
            BUNDLE_INSTALL_FLAGS: '--without test development'
  - name: migrate staging
    plan:
      - get: govwifi-admin
        trigger: true
        passed: ['Push Image']
      - task: 'migrate'
        file: govwifi-admin/ci/tasks/migrate.yml
        vars:
          deploy_stage: 'staging'
          aws-access-key-id: ((deploy-access-key-id))
          aws-secret-access-key: ((deploy-secret-access-key))
          aws-region: ((deploy-region))
